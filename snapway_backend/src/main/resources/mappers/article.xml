<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.snapway.model.mapper.ArticleMapper">

	<resultMap id="articleMap" type="Article">
		<id column="article_id" property="articleId"></id>
		<result column="title" property="title"></result>
		<result column="tags" property="tags"></result>
		<result column="author_id" property="authorId"></result>
		<result column="author_name" property="authorName"></result>
		<result column="category" property="category"></result>
		<result column="content" property="content"></result>
		<result column="likes" property="likes"></result>

		<result column="hits" property="hits"></result>
		<result column="uploaded_at" property="uploadedAt"></result>
		<result column="visibility" property="visibility"></result> 
	</resultMap>

	<select id="findAll" resultMap="articleMap">
		SELECT
			article_id,
			title,
			tags,
			author_id,
			author_name,
			category,
			content,
			likes,
			hits,
			uploaded_at,
			visibility  FROM article
			
			WHERE visibility = 'PUBLIC'
		    <if test="userId != null">
		        OR author_id = #{userId}
		    </if>
			
		ORDER BY article_id DESC;
	</select>

	<select id="getArticle" parameterType="long" resultMap="articleMap">
		SELECT
			article_id,
			title,
			tags,
			author_id,
			author_name,
			category,
			content,
			likes,
			hits,
			uploaded_at,
			visibility FROM article
		WHERE article_id = #{articleId}
	</select>

	<insert id="saveArticle"  
		useGeneratedKeys="true" keyProperty="articleId" keyColumn="article_id">
		INSERT INTO article(
			title,
			tags,
			author_id,
			author_name,
			category,
			content,
			likes,
			hits,
			uploaded_at,
			visibility )
		VALUES(
			#{article.title},
			#{article.tags},
			#{article.authorId},
			#{article.authorName},
			#{article.category},
			#{article.content},
			#{article.likes},
			#{article.hits},
			NOW(),
			COALESCE(#{article.visibility}, 'PUBLIC') 
		)
	</insert>

	<update id="updateArticle" parameterType="Article">
		UPDATE article
		SET
			title = #{title},
			tags = #{tags},
			category = #{category},
			content = #{content},
			visibility = #{visibility} WHERE article_id = #{articleId}
	</update>

	<delete id="deleteArticle" parameterType="long">
		DELETE FROM article
		WHERE article_id = #{articleId}
	</delete>

	<update id="increaseHits" parameterType="long">
		UPDATE article
		SET hits = hits + 1
		WHERE article_id = #{articleId}
	</update>

	<insert id="addReply">
		INSERT INTO
		reply(article_id, replier_id, content, replied_at)
		VALUES(#{reply.articleId}, #{reply.replierId}, #{reply.content}, NOW())
	</insert>

	<select id="getReply" parameterType="long" resultType="Reply">
	    SELECT 
	        r.reply_id,
	        r.article_id,
	        r.replier_id,
	        r.content,
	        r.replied_at,
	        m.username AS replier_name  FROM reply r
	    INNER JOIN member m ON r.replier_id = m.id  WHERE r.article_id = #{articleId}
	    ORDER BY r.replied_at ASC
	</select>

	<delete id="deleteReply">
		DELETE FROM reply
		WHERE reply_id = #{replyId}
		AND replier_id = #{replierId}
	</delete>

	<update id="updateReply">
		UPDATE reply SET content = #{reply.content}
		WHERE reply_id = #{reply.replyId}
		AND replier_id = #{reply.replierId}
	</update>
</mapper>